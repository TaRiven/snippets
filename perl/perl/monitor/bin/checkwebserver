#!/usr/local/bin/perl
# Copyright (c) 1997  Dustin Sallings
#
# $Id: checkwebserver,v 1.3 1997/12/14 21:32:31 dustin Exp $
# $Source: /Users/dustin/stuff/cvstest/perl/monitor/bin/Attic/checkwebserver,v $

use Socket;

push(@INC, "/home/monitor/lib");
require 'statlib.pl';

sub timeout
{
    alarm(0);
    $SIG{'ALRM'}=timeout;
    return(0);
}

sub GetStatus
{
    my($url)=@_;
    my($host, $request, @status);

    if($url eq "")
    {
	return("", 0, "Invalid URL format");
    }

    if(!($url=~/http:\/\/([^\/]+)(.*)/))
    {
	return("", 0, "Invalid URL format");
    }

    ($host, $request)=($1, $2);

    $request="/" if($request eq "");

    $proto=getprotobyname('tcp');
    socket(S, PF_INET, SOCK_STREAM, $proto);
    $sin=sockaddr_in(80, inet_aton($host));

    alarm(15);
    connect(S, $sin) || return("", "-1", "Connection error");
    alarm(0);

    print S "GET $request HTTP/1.0\n\n";

    chop($in=<S>);
    @status=split(/\s+/, $in, 3);
    close(S);
    return(@status);
}

$SIG{'ALRM'}=\&timeout;

open(OUT, ">$webstatus");

open(IN, $ARGV[0]) || die("$ARGV[0]: $!");
while(<IN>)
{
    chop;
    next if(/^#/);
    next unless(/[A-z0-9]+/);
    @status=GetStatus($_);
    # print "$_;$status[1]\n";
    if($status[1]=~/2\d\d/)
    {
	$color="#007f00";
    }
    else
    {
	$color="#ff0000";
    }
    print OUT "\t<li><font color=\"$color\">$status[1]</font> -- ";
    print OUT "<a href=\"$_\">$_</a></li>\n";
}
close(IN);

close(OUT);
